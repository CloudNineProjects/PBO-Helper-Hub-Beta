<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PBO Checklist</title>
<!-- Papaparse CDN -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
:root{
  --bg-light:#666769;
  --bg-dark:#1A252C;
  --card-light:#026503;
  --card-dark:#023804;
  --toggle-light:#F0F0F0;
  --toggle-dark:#444;
  --text-light:#ffffff;
  --text-dark:#ffffff;
}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,sans-serif}
body.light{background:var(--bg-light);color:var(--text-light)}
body.dark{background:var(--bg-dark);color:var(--text-dark)}

/* Toggle button (filled) */
.toggle{
  position:fixed;
  top:12px;
  right:12px;
  z-index:2000;
  padding:6px 12px;
  border-radius:8px;
  font-size:14px;
  cursor:pointer;
  user-select:none;
  box-shadow:0 6px 16px rgba(0,0,0,0.12);
}
body.light .toggle{ background:var(--toggle-light); color:#000; border:none; }
body.dark .toggle{ background:var(--toggle-dark); color:#fff; border:none; }

/* Loader */
.loader{min-height:100vh;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:14px;position:relative}
.loader img.logo{width:220px;height:220px;object-fit:cover;border-radius:50%;box-shadow:none}
.load-btn{padding:10px 18px;border-radius:8px;border:none;background:#0b74de;color:#fff;cursor:pointer;font-size:16px}

/* App */
.app-wrap{max-width:980px;margin:28px auto;padding:12px}
.card{background:var(--card-light);padding:16px;margin:16px 0;border-radius:10px;box-shadow:0 10px 22px rgba(0,0,0,0.08)}
body.dark .card{background:var(--card-dark)}
h1{margin:0 0 8px 0}
.section-title{display:flex;align-items:center;gap:12px;justify-content:space-between}
.controls{display:flex;gap:8px}
.button{padding:8px 12px;border-radius:8px;border:none;background:#eef3fb;color:#0b1720;cursor:pointer}
.button.secondary{background:transparent;color:inherit;border:1px solid rgba(255,255,255,0.06)}

/* items */
.item{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;margin:8px 0;display:block}
.item .row{display:flex;gap:12px;align-items:flex-start}
.item label{display:flex;align-items:center;gap:10px;flex:1;cursor:pointer}
.item .meta{font-size:0.9rem;color:rgba(255,255,255,0.85)}
.item .content{margin-top:8px;white-space:pre-wrap;font-family:inherit;background:rgba(0,0,0,0.06);padding:8px;border-radius:6px}
.checked .meta{ text-decoration:line-through; opacity:0.65 }

/* timestamps */
.ts{font-size:0.85rem;color:rgba(255,255,255,0.75);margin-left:8px}

/* overlay */
#overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.78);z-index:3000}
#overlay .box{background:#fff;color:#000;padding:18px;border-radius:10px;text-align:center;max-width:420px}
body.dark #overlay .box{background:#023804;color:#fff}
#overlay button{margin-top:10px;padding:8px 12px;border:none;border-radius:8px;background:#444;color:#fff;cursor:pointer}
</style>
</head>
<body class="light">
  <!-- Toggle (fixed) -->
  <div id="themeToggle" class="toggle">ðŸŒ™ Dark Mode</div>

  <!-- Loading screen -->
  <main id="loader" class="loader" aria-hidden="false">
    <img class="logo" src="https://i.imgur.com/XZcfQzw.png" alt="CloudNine logo">
    <button id="loadBtn" class="load-btn">Load Data</button>
    <div id="loadingText" style="margin-top:8px;display:none;color:rgba(255,255,255,0.85)">Loadingâ€¦</div>
  </main>

  <!-- App -->
  <div id="app" class="app-wrap" style="display:none">
    <h1 style="text-align:center">PBO Checklist</h1>

    <section class="card" id="secDaily">
      <div class="section-title">
        <strong>Daily</strong>
        <div class="controls"><button id="resetDaily" class="button">Reset Dailies</button></div>
      </div>
      <div id="dailyList"></div>
    </section>

    <section class="card" id="secWeekly">
      <div class="section-title">
        <strong>Weekly</strong>
        <div class="controls"><button id="resetWeekly" class="button">Reset Weeklies</button></div>
      </div>
      <div id="weeklyList"></div>
    </section>

    <section class="card" id="secOthers">
      <div class="section-title"><strong>Others</strong></div>
      <div id="othersList"></div>
    </section>

    <section class="card" id="secVS">
      <div class="section-title"><strong>VS Seeker</strong></div>
      <div id="vsBlock"></div>
    </section>
  </div>

  <!-- overlay -->
  <div id="overlay"><div class="box"><div id="overlayText">âš¡ VS Seeker is ready! âš¡</div><button id="closeOverlay">Close</button></div></div>

<script>
/* ========== Config ========== */
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSnQAomUZRPHbub-G3CwuUY9iByOE8Q1KHhat_xUIx3bUSo2TfG3DEkET3dumTbSKUMzDlCr3qo0BeN/pub?output=csv";

/* ========== Utilities ========== */
function $(id){return document.getElementById(id)}
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ========== Theme Toggle ========== */
const themeToggle = $('themeToggle');
function setMode(isDark){
  document.body.className = isDark ? 'dark' : 'light';
  themeToggle.textContent = isDark ? 'â˜€ï¸ Light Mode' : 'ðŸŒ™ Dark Mode';
}
themeToggle.addEventListener('click', ()=> setMode(document.body.className !== 'dark'));
setMode(false); // start light

/* ========== Load & Parse CSV (PapaParse) ========== */
let rawRows = []; // parsed rows (objects)
let canonicalRows = []; // normalized rows with Activity/Location/Content/Time

function mapHeaders(fields){
  // fields is array like ['Activity','Location','Content','Time'] - we map to canonical names
  const lower = fields.map(f=>f?f.trim().toLowerCase():'');
  const find = name => {
    const i = lower.indexOf(name);
    return i>=0 ? fields[i] : null;
  };
  return {
    Activity: find('activity') || find('a') || fields[0],
    Location: find('location') || find('b') || fields[1],
    Content: find('content') || find('c') || fields[2],
    Time: find('time') || find('d') || fields[3]
  };
}

function normalizeRow(r, keys){
  // produce object with canonical keys and trimmed Time
  const a = (r[keys.Activity] !== undefined) ? r[keys.Activity] : '';
  const b = (r[keys.Location] !== undefined) ? r[keys.Location] : '';
  const c = (r[keys.Content] !== undefined) ? r[keys.Content] : '';
  const t = (r[keys.Time] !== undefined) ? r[keys.Time] : '';
  return {
    Activity: String(a).trim(),
    Location: String(b).trim(),
    Content: String(c), // keep whitespace/newlines as-is
    Time: String(t).trim()
  };
}

function loadData(){
  $('loadingText').style.display='block';
  // use Papa.parse download mode for robustness
  Papa.parse(CSV_URL, {
    download: true,
    header: true,
    skipEmptyLines: true,
    transformHeader: h => h ? h.trim() : h,
    complete: (res) => {
      rawRows = res.data || [];
      const fields = res.meta && res.meta.fields ? res.meta.fields.map(f=>f.trim()) : [];
      const keys = mapHeaders(fields);
      canonicalRows = rawRows.map(r => normalizeRow(r, keys)).filter(r => r.Activity || r.Location || r.Content); // drop empty rows
      // render app
      $('loader').style.display='none';
      $('app').style.display='block';
      renderAll();
      startVsTimerLoop(); // ensure VS timer loop running
    },
    error: (err) => {
      console.error('CSV load error', err);
      $('loadingText').textContent = 'Error loading CSV';
    }
  });
}
$('loadBtn').addEventListener('click', loadData);

/* ========== LocalStorage keys utils ========= */
function keyChecked(i){ return `pbo_chk_${i}_checked`; }
function keyTs(i){ return `pbo_chk_${i}_ts`; }

/* ========== Rendering ========== */
function renderAll(){
  renderSection('Daily', 'dailyList');
  renderSection('Weekly', 'weeklyList');
  renderSection('Others', 'othersList');
  renderVSBlock();
}

function renderSection(timeLabel, containerId){
  const container = $(containerId);
  container.innerHTML = '';
  canonicalRows.forEach((r,i)=>{
    const tNorm = (r.Time||'').trim();
    // classify
    let section = 'Others';
    if (tNorm.toLowerCase() === 'daily') section='Daily';
    else if (tNorm.toLowerCase() === 'weekly') section='Weekly';
    if (section !== timeLabel) return;
    // build item
    const checked = localStorage.getItem(keyChecked(i)) === 'true';
    const ts = localStorage.getItem(keyTs(i)) || '';
    const div = document.createElement('div'); div.className = 'item' + (checked ? ' checked' : '');
    // top row with checkbox and meta
    const row = document.createElement('div'); row.className='row';
    const label = document.createElement('label');
    const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = checked;
    cb.style.marginRight='8px';
    cb.addEventListener('change', ()=> {
      localStorage.setItem(keyChecked(i), cb.checked ? 'true' : 'false');
      // update timestamp when checked
      if(cb.checked) localStorage.setItem(keyTs(i), new Date().toLocaleString());
      renderAll();
    });
    label.appendChild(cb);
    const meta = document.createElement('div'); meta.className='meta';
    meta.innerHTML = `<strong>${escapeHtml(r.Activity)}</strong> â€” <em>${escapeHtml(r.Location)}</em> <span class="ts">(${escapeHtml(r.Time)})</span>`;
    label.appendChild(meta);
    row.appendChild(label);
    // timestamp displayed on right
    const tsSpan = document.createElement('div'); tsSpan.className='ts'; tsSpan.textContent = ts ? `Last done: ${ts}` : '';
    row.appendChild(tsSpan);
    div.appendChild(row);
    // content block (preserve line breaks)
    const content = document.createElement('pre'); content.className='content'; content.style.whiteSpace='pre-wrap';
    content.textContent = r.Content || '';
    div.appendChild(content);
    // for Others: add Reset button that only unchecks (timestamp preserved)
    if(timeLabel === 'Others'){
      const btn = document.createElement('button');
      btn.className = 'button secondary';
      btn.textContent = 'Reset';
      btn.addEventListener('click', ()=> {
        localStorage.setItem(keyChecked(i), 'false');
        renderAll();
      });
      div.appendChild(btn);
    }
    container.appendChild(div);
  });
}

/* Reset buttons for Daily/Weekly: uncheck but keep timestamps */
$('resetDaily').addEventListener('click', ()=>{
  canonicalRows.forEach((r,i)=>{
    if((r.Time||'').trim().toLowerCase() === 'daily'){
      localStorage.setItem(keyChecked(i),'false');
    }
  });
  renderAll();
});
$('resetWeekly').addEventListener('click', ()=>{
  canonicalRows.forEach((r,i)=>{
    if((r.Time||'').trim().toLowerCase() === 'weekly'){
      localStorage.setItem(keyChecked(i),'false');
    }
  });
  renderAll();
});

/* ========== VS Seeker ========== */
const VS_KEY_LAST = 'pbo_vs_last';       // ms timestamp when started
const VS_KEY_ALERTED = 'pbo_vs_alerted'; // boolean flag
let vsIntervalHandle = null;
let tabFlashHandle = null;
let originalTitle = document.title;

function renderVSBlock(){
  const cont = $('vsBlock');
  cont.innerHTML = '';
  const div = document.createElement('div'); div.className='item';
  // show checkbox + timestamp + timer
  const last = parseInt(localStorage.getItem(VS_KEY_LAST) || '0', 10) || 0;
  const now = Date.now();
  const end = last ? (last + 5*60*1000) : 0;
  const remaining = end ? Math.max(0, Math.floor((end - now) / 1000)) : -1;
  // build elements
  const label = document.createElement('label');
  const cb = document.createElement('input'); cb.type='checkbox';
  cb.checked = last && (now < end);
  cb.style.marginRight='8px';
  const meta = document.createElement('div'); meta.className='meta'; meta.innerHTML = `<strong>VS Seeker</strong>`;
  label.appendChild(cb); label.appendChild(meta);
  div.appendChild(label);
  const tsSpan = document.createElement('div'); tsSpan.className='ts';
  tsSpan.textContent = last ? `Started: ${new Date(last).toLocaleString()}` : '';
  div.appendChild(tsSpan);
  const timerSpan = document.createElement('div'); timerSpan.id = 'vsTimer'; timerSpan.className='ts';
  div.appendChild(timerSpan);
  cont.appendChild(div);

  // checkbox logic
  cb.addEventListener('change', ()=> {
    if(cb.checked){
      const nowMs = Date.now();
      localStorage.setItem(VS_KEY_LAST, String(nowMs));
      localStorage.removeItem(VS_KEY_ALERTED);
      startVsInterval();
    } else {
      localStorage.removeItem(VS_KEY_LAST);
      localStorage.removeItem(VS_KEY_ALERTED);
      stopVsInterval();
      timerSpan.textContent = '';
    }
    renderVSBlock(); // refresh UI
  });

  // if currently running, ensure timer active
  if(remaining > 0){
    startVsInterval();
  } else if (remaining === 0) {
    // ready now â€” show overlay & flash if not alerted
    if(!localStorage.getItem(VS_KEY_ALERTED)){
      showOverlay();
      flashTab('âš¡ VS Seeker ready! âš¡');
      localStorage.setItem(VS_KEY_ALERTED, 'true');
    }
    timerSpan.textContent = 'ready!';
  } else {
    timerSpan.textContent = '';
  }
}

function startVsInterval(){
  stopVsInterval();
  vsIntervalHandle = setInterval(()=>{
    const last = parseInt(localStorage.getItem(VS_KEY_LAST) || '0',10) || 0;
    if(!last) return;
    const now = Date.now();
    const end = last + 2*60*60*1000;
    const rem = Math.max(0, Math.floor((end - now)/1000));
    const el = $('vsTimer');
    if(el){
      if(rem > 0){
        const h = Math.floor(rem/3600); const m = Math.floor((rem%3600)/60); const s = rem%60;
        el.textContent = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
      } else {
        el.textContent = 'ready!';
        // trigger overlay and tab flash once
        if(!localStorage.getItem(VS_KEY_ALERTED)){
          showOverlay();
          flashTab('âš¡ VS Seeker ready! âš¡');
          localStorage.setItem(VS_KEY_ALERTED, 'true');
        }
        stopVsInterval();
      }
    }
  }, 1000);
}

function stopVsInterval(){
  if(vsIntervalHandle){ clearInterval(vsIntervalHandle); vsIntervalHandle = null; }
}

/* Overlay */
function showOverlay(){ $('overlay').style.display='flex'; }
$('closeOverlay').addEventListener('click', ()=> { $('overlay').style.display='none'; });

/* Tab flashing (title) */
function flashTab(msg){
  if(tabFlashHandle) clearInterval(tabFlashHandle);
  originalTitle = document.title;
  let state = true;
  tabFlashHandle = setInterval(()=> {
    document.title = state ? msg : originalTitle;
    state = !state;
  }, 800);
  // stop when user focuses tab
  window.addEventListener('focus', ()=> {
    if(tabFlashHandle) clearInterval(tabFlashHandle);
    document.title = originalTitle;
  }, { once:true });
}

/* Start a background loop to keep VS timer/overlay in sync */
let vsLoopStarted = false;
function startVsTimerLoop(){
  if(vsLoopStarted) return;
  vsLoopStarted = true;
  // run every second to keep UI in sync (also if CSV reloaded)
  setInterval(()=> {
    // re-render VS block only (cheap)
    try{ renderVSBlock(); }catch(e){/*ignore*/ }
  }, 1000);
}

/* ========== Init helpers ========== */
/* ensure UI elements exist and wire reset buttons (they exist in DOM) */
document.addEventListener('DOMContentLoaded', ()=> {
  // wire theme toggle also for keyboard (optional)
  // themeToggle already wired above
});
</script>
</body>
</html>
