<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PBO Checklist</title>
<style>
:root {
  --bg-light:#666769;
  --bg-dark:#1A252C;
  --card-light:#026503;
  --card-dark:#023804;
  --text-light:#fff;
  --text-dark:#fff;
}
body{margin:0;font-family:sans-serif;transition:background 0.3s,color 0.3s}
body.light{background:var(--bg-light);color:var(--text-light)}
body.dark{background:var(--bg-dark);color:var(--text-dark)}
header{display:flex;justify-content:flex-end;padding:10px}
.toggle{cursor:pointer}
.loader{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh}
.loader img.logo{width:220px;height:220px;object-fit:cover;border-radius:50%;box-shadow:none}
button{cursor:pointer;border:none;padding:8px 16px;margin:4px;border-radius:6px;font-size:1rem}
.card{background:var(--card-light);padding:16px;margin:16px;border-radius:8px;color:white}
body.dark .card{background:var(--card-dark)}
h2{margin-top:0}
label{display:flex;align-items:center;gap:8px;margin:6px 0}
label.checked{text-decoration:line-through;opacity:0.7}
.timestamp{font-size:0.85rem;color:#ddd;margin-left:auto}
.overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;color:white;font-size:1.5rem;z-index:1000}
.overlay .box{background:#023804;padding:20px;border-radius:8px;position:relative}
.overlay button{position:absolute;top:5px;right:5px;background:red;color:white;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer}
</style>
</head>
<body class="light">

<div id="loading" class="loader">
  <div class="toggle" id="modeToggle">ðŸŒž Light Mode</div>
  <img src="https://i.imgur.com/XZcfQzw.png" alt="logo" class="logo"/>
  <button id="loadBtn">Load Data</button>
  <div id="loadingText" style="margin-top:10px;display:none">Loading...</div>
</div>

<div id="app" style="display:none">
  <header>
    <div class="toggle" id="modeToggleApp">ðŸŒž Light Mode</div>
  </header>
  <div id="daily" class="card"><h2>Daily <button id="resetDaily">Reset Dailies</button></h2><div class="list"></div></div>
  <div id="weekly" class="card"><h2>Weekly <button id="resetWeekly">Reset Weeklies</button></h2><div class="list"></div></div>
  <div id="others" class="card"><h2>Others</h2><div class="list"></div></div>
  <div id="vsseeker" class="card"><h2>VS Seeker</h2>
    <label><input type="checkbox" id="vsCheck"/> VS Seeker</label>
    <div id="vsTimer"></div>
  </div>
</div>

<div id="overlay" class="overlay" style="display:none">
  <div class="box">
    <button id="closeOverlay">âœ–</button>
    VS Seeker is ready!
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
const SHEET_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vSnQAomUZRPHbub-G3CwuUY9iByOE8Q1KHhat_xUIx3bUSo2TfG3DEkET3dumTbSKUMzDlCr3qo0BeN/pub?output=csv";
let data=[];

function escapeHtml(str){return str?str.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m])):''}

function renderList(section,rows){
  const container=document.querySelector("#"+section+" .list");
  container.innerHTML="";
  rows.forEach((r,i)=>{
    const key=section+"_"+i+"_"+r.Activity;
    const checked=localStorage.getItem(key+"_checked")==="true";
    const ts=localStorage.getItem(key+"_ts")||"";
    const label=document.createElement("label");
    if(checked)label.classList.add("checked");
    const cb=document.createElement("input");cb.type="checkbox";cb.checked=checked;
    cb.addEventListener("change",()=>{
      localStorage.setItem(key+"_checked",cb.checked);
      localStorage.setItem(key+"_ts",new Date().toLocaleString());
      renderAll();
    });
    label.appendChild(cb);
    label.appendChild(document.createTextNode(`${r.Activity} | ${r.Location} | ${r.Content} | ${r.Time}`));
    const span=document.createElement("span");span.className="timestamp";span.textContent=ts?`Last done: ${ts}`:"";
    label.appendChild(span);
    container.appendChild(label);
    if(section==="others"){
      const resetBtn=document.createElement("button");resetBtn.textContent="Reset";
      resetBtn.onclick=()=>{localStorage.setItem(key+"_checked",false);renderAll()};
      container.appendChild(resetBtn);
    }
  });
}

function renderAll(){
  renderList("daily",data.filter(r=>r.Time==="Daily"));
  renderList("weekly",data.filter(r=>r.Time==="Weekly"));
  renderList("others",data.filter(r=>r.Time!=="Daily"&&r.Time!=="Weekly"));
}

function loadData(){
  document.getElementById("loadingText").style.display="block";
  fetch(SHEET_URL).then(r=>r.text()).then(txt=>{
    const parsed=Papa.parse(txt,{header:true,skipEmptyLines:true});
    data=parsed.data;
    document.getElementById("loading").style.display="none";
    document.getElementById("app").style.display="block";
    renderAll();
  });
}

document.getElementById("loadBtn").onclick=loadData;
document.getElementById("resetDaily").onclick=()=>{
  data.filter(r=>r.Time==="Daily").forEach((r,i)=>localStorage.setItem("daily_"+i+"_"+r.Activity+"_checked",false));
  renderAll();
};
document.getElementById("resetWeekly").onclick=()=>{
  data.filter(r=>r.Time==="Weekly").forEach((r,i)=>localStorage.setItem("weekly_"+i+"_"+r.Activity+"_checked",false));
  renderAll();
};

// VS Seeker
function updateVsTimer(){
  const last=localStorage.getItem("vs_last");
  const vsChecked=document.getElementById("vsCheck");
  const timerDiv=document.getElementById("vsTimer");
  if(last){
    const diff=Date.now()-parseInt(last);
    const remain=2*60*60*1000-diff;
    if(remain>0){
      const m=Math.floor(remain/60000);const s=Math.floor((remain%60000)/1000);
      timerDiv.textContent=`${m}m ${s}s remaining`;
      setTimeout(updateVsTimer,1000);
    }else{
      timerDiv.textContent="Ready!";
      if(!localStorage.getItem("vs_alerted")){
        document.getElementById("overlay").style.display="flex";
        localStorage.setItem("vs_alerted","true");
      }
    }
  }else{
    timerDiv.textContent="";
  }
  vsChecked.checked=!!last;
}
document.getElementById("vsCheck").onchange=()=>{
  if(document.getElementById("vsCheck").checked){
    localStorage.setItem("vs_last",Date.now());
    localStorage.removeItem("vs_alerted");
    updateVsTimer();
  }else{
    localStorage.removeItem("vs_last");
    localStorage.removeItem("vs_alerted");
    document.getElementById("vsTimer").textContent="";
  }
};
document.getElementById("closeOverlay").onclick=()=>{
  document.getElementById("overlay").style.display="none";
};

// Mode toggle
function setMode(mode){
  document.body.className=mode;
  document.querySelectorAll(".toggle").forEach(el=>{
    el.textContent=mode==="light"?"ðŸŒž Light Mode":"ðŸŒ™ Dark Mode";
  });
}
document.getElementById("modeToggle").onclick=()=>{
  setMode(document.body.className==="light"?"dark":"light");
};
document.getElementById("modeToggleApp").onclick=()=>{
  setMode(document.body.className==="light"?"dark":"light");
};
setMode("light");
updateVsTimer();
</script>
</body>
</html>
