<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PBO Checklist</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #666769;
      color: white;
      transition: background 0.3s, color 0.3s;
    }
    body.dark {
      background-color: #1A252C;
      color: white;
    }
    header {
      display: flex;
      justify-content: flex-end;
      padding: 10px;
    }
    .toggle-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 20px;
      color: inherit;
    }
    .loader {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    .card {
      background-color: #026503;
      padding: 20px;
      margin: 20px;
      border-radius: 8px;
    }
    body.dark .card {
      background-color: #023804;
    }
    select, button {
      margin: 5px 0;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    button {
      cursor: pointer;
    }
    .strikethrough {
      text-decoration: line-through;
      opacity: 0.6;
    }
    .timestamp {
      font-size: 0.8em;
      color: #ddd;
      margin-left: 10px;
    }
    .vs-popup {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .vs-popup-content {
      background: #fff;
      color: #000;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    .vs-popup-content button {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div id="loading-screen">
    <header>
      <button id="mode-toggle" class="toggle-btn">‚òÄÔ∏è Light Mode</button>
    </header>
    <div class="loader">
      <img src="https://i.imgur.com/XZcfQzw.png" alt="Loading" style="max-width:300px;">
      <button id="load-btn">Load Data</button>
      <p id="loading-text" style="display:none;">Loading...</p>
    </div>
  </div>

  <div id="app" style="display:none;">
    <header>
      <button id="mode-toggle-app" class="toggle-btn">‚òÄÔ∏è Light Mode</button>
    </header>
    <div class="card">
      <h2>Daily</h2>
      <div id="daily-list"></div>
      <button id="reset-daily">Reset Dailies</button>
    </div>
    <div class="card">
      <h2>Weekly</h2>
      <div id="weekly-list"></div>
      <button id="reset-weekly">Reset Weeklies</button>
    </div>
    <div class="card">
      <h2>Others</h2>
      <div id="others-list"></div>
    </div>
    <div class="card">
      <h2>VS Seeker</h2>
      <label><input type="checkbox" id="vs-checkbox"> VS Seeker</label>
      <span id="vs-timer"></span>
    </div>
  </div>

  <div id="vs-popup" class="vs-popup" style="display:none;">
    <div class="vs-popup-content">
      <p>VS Seeker is ready!</p>
      <button id="close-popup">Close</button>
    </div>
  </div>

  <script>
    const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSnQAomUZRPHbub-G3CwuUY9iByOE8Q1KHhat_xUIx3bUSo2TfG3DEkET3dumTbSKUMzDlCr3qo0BeN/pub?output=csv";
    let data = [];
    let vsTimerInterval;

    const loadingScreen = document.getElementById("loading-screen");
    const app = document.getElementById("app");
    const loadBtn = document.getElementById("load-btn");
    const loadingText = document.getElementById("loading-text");

    const modeToggle = document.getElementById("mode-toggle");
    const modeToggleApp = document.getElementById("mode-toggle-app");

    function toggleMode() {
      document.body.classList.toggle("dark");
      const isDark = document.body.classList.contains("dark");
      modeToggle.textContent = isDark ? "üåô Dark Mode" : "‚òÄÔ∏è Light Mode";
      modeToggleApp.textContent = isDark ? "üåô Dark Mode" : "‚òÄÔ∏è Light Mode";
    }
    modeToggle.addEventListener("click", toggleMode);
    modeToggleApp.addEventListener("click", toggleMode);

    loadBtn.addEventListener("click", () => {
      loadingText.style.display = "block";
      fetch(sheetUrl)
        .then(res => res.text())
        .then(text => {
          data = Papa.parse(text, {header: true}).data;
          render();
          loadingScreen.style.display = "none";
          app.style.display = "block";
        });
    });

    function render() {
      renderSection("Daily", "daily-list", "reset-daily");
      renderSection("Weekly", "weekly-list", "reset-weekly");
      renderOthers();
      initVSSeeker();
    }

    function renderSection(type, listId, resetId) {
      const list = document.getElementById(listId);
      list.innerHTML = "";
      data.filter(r => r.Time === type).forEach((row, idx) => {
        const div = document.createElement("div");
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.id = `${listId}-${idx}`;
        const saved = JSON.parse(localStorage.getItem(cb.id) || "{}");
        cb.checked = saved.checked || false;
        const label = document.createElement("label");
        label.textContent = `${row.Activity} - ${row.Location} - ${row.Content}`;
        if (cb.checked) label.classList.add("strikethrough");
        const ts = document.createElement("span");
        ts.className = "timestamp";
        ts.textContent = saved.timestamp ? `Last: ${saved.timestamp}` : "";
        cb.addEventListener("change", () => {
          const now = new Date().toLocaleString();
          localStorage.setItem(cb.id, JSON.stringify({checked: cb.checked, timestamp: now}));
          label.classList.toggle("strikethrough", cb.checked);
          ts.textContent = cb.checked ? `Last: ${now}` : saved.timestamp ? `Last: ${saved.timestamp}` : "";
        });
        div.appendChild(cb);
        div.appendChild(label);
        div.appendChild(ts);
        list.appendChild(div);
      });
      document.getElementById(resetId).addEventListener("click", () => {
        [...list.querySelectorAll("input[type=checkbox]")].forEach(cb => {
          cb.checked = false;
          const saved = JSON.parse(localStorage.getItem(cb.id) || "{}");
          if (saved.timestamp) {
            localStorage.setItem(cb.id, JSON.stringify({checked: false, timestamp: saved.timestamp}));
          } else {
            localStorage.removeItem(cb.id);
          }
          cb.nextSibling.classList.remove("strikethrough");
        });
      });
    }

    function renderOthers() {
      const list = document.getElementById("others-list");
      list.innerHTML = "";
      data.filter(r => r.Time !== "Daily" && r.Time !== "Weekly").forEach((row, idx) => {
        const div = document.createElement("div");
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.id = `others-${idx}`;
        const saved = JSON.parse(localStorage.getItem(cb.id) || "{}");
        cb.checked = saved.checked || false;
        const label = document.createElement("label");
        label.textContent = `${row.Activity} - ${row.Location} - ${row.Content} (${row.Time})`;
        if (cb.checked) label.classList.add("strikethrough");
        const ts = document.createElement("span");
        ts.className = "timestamp";
        ts.textContent = saved.timestamp ? `Last: ${saved.timestamp}` : "";
        const resetBtn = document.createElement("button");
        resetBtn.textContent = "Reset";
        cb.addEventListener("change", () => {
          const now = new Date().toLocaleString();
          localStorage.setItem(cb.id, JSON.stringify({checked: cb.checked, timestamp: now}));
          label.classList.toggle("strikethrough", cb.checked);
          ts.textContent = cb.checked ? `Last: ${now}` : saved.timestamp ? `Last: ${saved.timestamp}` : "";
        });
        resetBtn.addEventListener("click", () => {
          cb.checked = false;
          const saved = JSON.parse(localStorage.getItem(cb.id) || "{}");
          if (saved.timestamp) {
            localStorage.setItem(cb.id, JSON.stringify({checked: false, timestamp: saved.timestamp}));
          } else {
            localStorage.removeItem(cb.id);
          }
          label.classList.remove("strikethrough");
        });
        div.appendChild(cb);
        div.appendChild(label);
        div.appendChild(ts);
        div.appendChild(resetBtn);
        list.appendChild(div);
      });
    }

    function initVSSeeker() {
      const vsCb = document.getElementById("vs-checkbox");
      const vsTimer = document.getElementById("vs-timer");
      const saved = JSON.parse(localStorage.getItem("vs-seeker") || "{}");
      if (saved.endTime) startVSTimer(new Date(saved.endTime));
      vsCb.addEventListener("change", () => {
        if (vsCb.checked) {
          const endTime = new Date(Date.now() + 2*60*60*1000);
          localStorage.setItem("vs-seeker", JSON.stringify({endTime}));
          startVSTimer(endTime);
        } else {
          clearInterval(vsTimerInterval);
          vsTimer.textContent = "";
          localStorage.removeItem("vs-seeker");
        }
      });
    }

    function startVSTimer(endTime) {
      clearInterval(vsTimerInterval);
      const vsTimer = document.getElementById("vs-timer");
      vsTimerInterval = setInterval(() => {
        const diff = endTime - new Date();
        if (diff <= 0) {
          clearInterval(vsTimerInterval);
          vsTimer.textContent = "";
          document.getElementById("vs-popup").style.display = "flex";
        } else {
          const h = Math.floor(diff/3600000);
          const m = Math.floor((diff%3600000)/60000);
          const s = Math.floor((diff%60000)/1000);
          vsTimer.textContent = ` (${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')})`;
        }
      }, 1000);
    }
    document.getElementById("close-popup").addEventListener("click", () => {
      document.getElementById("vs-popup").style.display = "none";
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
</body>
</html>
