<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PBO Item Finder</title>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg:#666769;
      --card:#02491D;
      --text:#ffffff;
      --accent:#eef3fb;
      --radius:10px;
    }

    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      background:var(--bg);
      color:var(--text);
    }

    header{
      display:flex;
      justify-content:flex-end;
      padding:12px;
    }

    button{
      padding:10px 18px;
      border:none;
      border-radius:8px;
      cursor:pointer;
      background:var(--accent);
      color:#000;
    }

    button.secondary{
      background:#1f2937;
      color:#fff;
    }

    main{
      max-width:1000px;
      margin:0 auto;
      padding:12px;
    }

    .loading{
      height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      padding:16px;
      margin-top:16px;
    }

    .row{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      margin-top:12px;
      align-items:center;
    }

    select,input{
      padding:8px;
      border-radius:8px;
      border:none;
      min-width:220px;
    }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:14px;
    }

    th,td{
      padding:8px;
      border-bottom:1px solid rgba(255,255,255,0.15);
      text-align:left;
    }

    .muted{opacity:0.8;margin-top:12px}
    .hidden{display:none}

    /* Dark mode */
    .dark-mode{
      --bg:#1A252C;
      --card:#023804;
    }
  </style>
</head>
<body>

<header>
  <button id="darkToggle" class="secondary">ðŸŒ™ Dark Mode</button>
</header>

<main>

  <!-- Loading -->
  <div id="loading" class="loading">
    <div>
      <img src="https://i.imgur.com/XZcfQzw.png" style="max-width:200px;margin-bottom:12px">
      <div>
        <button id="loadBtn">Load Data</button>
      </div>
      <div id="loadStatus" class="muted"></div>
    </div>
  </div>

  <!-- App -->
  <div id="app" class="hidden">

    <section class="card">
      <h2>Special Item Finder</h2>

      <!-- Fuzzy Search -->
      <div class="row">
        <input id="manualInput" type="text" placeholder="Search item (e.g. TM070, Trick Room)" />
        <button id="manualBtn">Search</button>
        <button id="manualReset" class="secondary">Reset</button>
      </div>
      <div id="manualOut"></div>

      <hr style="margin:18px 0;opacity:0.2">

      <!-- Filtered Search -->
      <div class="row">
        <select id="regionSelect"><option value="">Select Region</option></select>
        <select id="locationSelect" disabled><option value="">Select Location</option></select>
        <select id="itemSelect" disabled><option value="">Select Item</option></select>
        <button id="filterBtn">Search</button>
        <button id="filterReset" class="secondary">Reset</button>
      </div>
      <div id="filterOut"></div>

    </section>

  </div>

</main>

<script>
/* ===== Helpers ===== */
const $ = id => document.getElementById(id);
const normalize = s => (s||'').toString().trim().toLowerCase();
const escapeHtml = s => (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

/* ===== CSV ===== */
const ITEM_CSV =
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vSVGd00wRMYJ_keK_ESGV_RUw6yUHUbsexmiXfm9pp8vw_oUGnvYmCKMCNaKwvTNVi8lXED_Qi11edq/pub?output=csv';

let rows = [];
let fields = [];

/* ===== Load ===== */
function loadData(){
  $('loadBtn').disabled = true;
  $('loadStatus').textContent = 'Loading...';

  Papa.parse(ITEM_CSV,{
    download:true,
    header:true,
    skipEmptyLines:true,
    complete:(res)=>{
      rows = res.data.filter(r => Object.values(r).some(v => v && String(v).trim() !== ''));
      fields = res.meta.fields;
      initUI();
      $('loading').style.display='none';
      $('app').classList.remove('hidden');
    },
    error:()=>{
      $('loadStatus').textContent='Failed to load CSV';
      $('loadBtn').disabled=false;
    }
  });
}

/* ===== UI Init ===== */
function initUI(){
  const regionKey   = fields[0];
  const locationKey = fields[1];
  const itemKey     = fields[2];

  const regions = [...new Set(rows.map(r => r[regionKey]).filter(Boolean))];
  regions.forEach(r => $('regionSelect').add(new Option(r,r)));

  $('regionSelect').onchange = ()=>{
    $('locationSelect').innerHTML = '<option value="">Select Location</option>';
    $('itemSelect').innerHTML = '<option value="">Select Item</option>';
    $('itemSelect').disabled = true;

    const region = $('regionSelect').value;
    if(!region){ $('locationSelect').disabled=true; return; }

    const locs = [...new Set(rows.filter(r => r[regionKey]===region).map(r => r[locationKey]))];
    locs.forEach(l => $('locationSelect').add(new Option(l,l)));
    $('locationSelect').disabled = false;
  };

  $('locationSelect').onchange = ()=>{
    $('itemSelect').innerHTML = '<option value="">Select Item</option>';
    const region = $('regionSelect').value;
    const loc    = $('locationSelect').value;
    if(!region || !loc){ $('itemSelect').disabled=true; return; }

    const items = [...new Set(rows.filter(r => r[regionKey]===region && r[locationKey]===loc).map(r => r[itemKey]))];
    items.forEach(i => $('itemSelect').add(new Option(i,i)));
    $('itemSelect').disabled = false;
  };

  // manual search
  $('manualBtn').onclick = ()=>{
    const q = normalize($('manualInput').value);
    const out = $('manualOut');
    if(!q){ out.innerHTML='<p class="muted">Enter search term.</p>'; return; }
    const hits = rows.filter(r => normalize(r[itemKey]).includes(q));
    out.innerHTML = hits.length ? renderTable(hits) : '<p class="muted">No results.</p>';
  };

  $('manualReset').onclick = ()=>{
    $('manualInput').value='';
    $('manualOut').innerHTML='';
  };

  $('filterBtn').onclick = ()=>{
    const r = $('regionSelect').value;
    const l = $('locationSelect').value;
    const i = $('itemSelect').value;
    const out = $('filterOut');
    if(!r||!l||!i){ out.innerHTML='<p class="muted">Select region, location and item.</p>'; return; }
    const hits = rows.filter(row => row[regionKey]===r && row[locationKey]===l && row[itemKey]===i);
    out.innerHTML = hits.length ? renderTable(hits) : '<p class="muted">No results.</p>';
  };

  $('filterReset').onclick = ()=>{
    $('regionSelect').selectedIndex=0;
    $('locationSelect').innerHTML='<option value="">Select Location</option>';
    $('locationSelect').disabled=true;
    $('itemSelect').innerHTML='<option value="">Select Item</option>';
    $('itemSelect').disabled=true;
    $('filterOut').innerHTML='';
  };
}

/* ===== Render ===== */
function renderTable(data){
  let html = '<table><thead><tr>';
  fields.forEach(f => html+=`<th>${escapeHtml(f)}</th>`);
  html += '</tr></thead><tbody>';
  data.forEach(r=>{
    html+='<tr>';
    fields.forEach(f=>html+=`<td>${escapeHtml(String(r[f]||''))}</td>`);
    html+='</tr>';
  });
  html+='</tbody></table>';
  return html;
}

/* ===== Events ===== */
$('loadBtn').addEventListener('click', loadData);
$('darkToggle').addEventListener('click',()=>{
  document.body.classList.toggle('dark-mode');
  $('darkToggle').textContent =
    document.body.classList.contains('dark-mode')
      ? 'â˜€ï¸ Light Mode'
      : 'ðŸŒ™ Dark Mode';
});
$('manualInput').addEventListener('keydown',e=>{
  if(e.key==='Enter'){ e.preventDefault(); $('manualBtn').click(); }
});
</script>

</body>
</html>
