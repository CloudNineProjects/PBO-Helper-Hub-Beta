<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PBO Route Planner</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
:root{
  --bg:#666769;
  --card:#02491D;
  --text:#ffffff;
  --accent:#eef3fb;
  --radius:10px;
}
body{
  margin:0;
  font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
  background:var(--bg);
  color:var(--text);
}
body.dark{
  --bg:#1A252C;
  --card:#023804;
}
header{
  display:flex;
  justify-content:flex-end;
  padding:12px;
}
button{
  padding:10px 18px;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
button.primary{background:var(--accent);color:#000}
button.secondary{background:#1f2937;color:#fff}

main{
  max-width:1100px;
  margin:0 auto;
  padding:12px;
}
.loading{
  height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
}
.card{
  background:var(--card);
  border-radius:var(--radius);
  padding:16px;
  margin-top:16px;
}
.controls{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  align-items:center;
}
select{
  padding:8px;
  border-radius:8px;
  border:none;
  min-width:220px;
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:14px;
}
th,td{
  padding:8px;
  border-bottom:1px solid rgba(255,255,255,0.15);
  text-align:left;
}
.hidden{display:none}
.muted{opacity:.8;margin-top:12px}
</style>
</head>

<body>

<header>
  <button id="darkToggle" class="secondary">üåô Dark Mode</button>
</header>

<main>

<!-- Loading -->
<div id="loading" class="loading">
  <div>
    <img src="https://i.imgur.com/XZcfQzw.png" style="max-width:200px;margin-bottom:12px">
    <div><button id="loadBtn" class="primary">Load Data</button></div>
    <div id="loadStatus" class="muted"></div>
  </div>
</div>

<!-- App -->
<div id="app" class="hidden">

  <!-- ROUTE PLANNER CARD -->
  <section class="card">
    <h2>Route Planner</h2>
    <div class="controls">
      <select id="routeRegion"><option value="">Select Region</option></select>
      <select id="routeLocation" disabled><option value="">Select Location</option></select>
      <button id="routeShow" class="primary">Show</button>
    </div>
    <div id="routeOut"></div>
  </section>

  <!-- EV SPOT FINDER CARD -->
  <section class="card">
    <h2>EV Spot Finder</h2>
    <div class="controls">
      <select id="evRegion"><option value="">Select Region</option></select>
      <select id="evStat" disabled><option value="">Select EV</option></select>
      <button id="evShow" class="primary">Show</button>
    </div>
    <div id="evOut"></div>
  </section>

</div>

</main>

<script>
/* ===== Helpers ===== */
const $ = id => document.getElementById(id);
const esc = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;');

/* ===== CSV URLs ===== */
const ROUTE_CSV = 'https://docs.google.com/spreadsheets/d/e/XXXXXXXX/pub?output=csv';
const EV_CSV    = 'https://docs.google.com/spreadsheets/d/e/YYYYYYYY/pub?output=csv';

/* ===== State ===== */
let routeRows=[], routeFields=[];
let evRows=[], evFields=[];

/* ===== Load ===== */
$('loadBtn').onclick = ()=>{
  $('loadBtn').disabled=true;
  $('loadStatus').textContent='Loading...';

  Promise.all([loadRoute(), loadEV()]).then(()=>{
    $('loading').style.display='none';
    $('app').classList.remove('hidden');
  }).catch(()=>{
    $('loadStatus').textContent='Failed to load data';
    $('loadBtn').disabled=false;
  });
};

function loadRoute(){
  return new Promise((res,rej)=>{
    Papa.parse(ROUTE_CSV,{
      download:true,header:true,skipEmptyLines:true,
      complete:r=>{
        routeRows=r.data; routeFields=r.meta.fields;
        initRoute();
        res();
      },
      error:rej
    });
  });
}

function loadEV(){
  return new Promise((res,rej)=>{
    Papa.parse(EV_CSV,{
      download:true,header:true,skipEmptyLines:true,
      complete:r=>{
        evRows=r.data; evFields=r.meta.fields;
        initEV();
        res();
      },
      error:rej
    });
  });
}

/* ===== Route Planner ===== */
function initRoute(){
  const rKey=routeFields[0], lKey=routeFields[1];
  [...new Set(routeRows.map(r=>r[rKey]))].forEach(v=>{
    $('routeRegion').add(new Option(v,v));
  });

  $('routeRegion').onchange=()=>{
    $('routeLocation').innerHTML='<option value="">Select Location</option>';
    $('routeLocation').disabled=true;
    const r=$('routeRegion').value;
    if(!r)return;
    [...new Set(routeRows.filter(x=>x[rKey]===r).map(x=>x[lKey]))]
      .forEach(v=>$('routeLocation').add(new Option(v,v)));
    $('routeLocation').disabled=false;
  };

  $('routeShow').onclick=()=>{
    const r=$('routeRegion').value,l=$('routeLocation').value;
    if(!r||!l)return;
    const hits=routeRows.filter(x=>x[rKey]===r&&x[lKey]===l);
    $('routeOut').innerHTML=renderTable(routeFields,hits);
  };
}

/* ===== EV Spot Finder ===== */
function initEV(){
  const rKey=evFields[0], evKey=evFields[1];
  [...new Set(evRows.map(r=>r[rKey]))].forEach(v=>{
    $('evRegion').add(new Option(v,v));
  });

  $('evRegion').onchange=()=>{
    $('evStat').innerHTML='<option value="">Select EV</option>';
    $('evStat').disabled=true;
    const r=$('evRegion').value;
    if(!r)return;
    [...new Set(evRows.filter(x=>x[rKey]===r).map(x=>x[evKey]))]
      .forEach(v=>$('evStat').add(new Option(v,v)));
    $('evStat').disabled=false;
  };

  $('evShow').onclick=()=>{
    const r=$('evRegion').value,e=$('evStat').value;
    if(!r||!e)return;
    const hits=evRows.filter(x=>x[rKey]===r&&x[evKey]===e);
    const displayFields=evFields.slice(2); // ohne Region + EV
    $('evOut').innerHTML=renderTable(displayFields,hits);
  };
}

/* ===== Table ===== */
function renderTable(fields,data){
  if(!data.length) return '<p class="muted">No results.</p>';
  let h='<table><thead><tr>';
  fields.forEach(f=>h+=`<th>${esc(f)}</th>`);
  h+='</tr></thead><tbody>';
  data.forEach(r=>{
    h+='<tr>';
    fields.forEach(f=>h+=`<td>${esc(r[f])}</td>`);
    h+='</tr>';
  });
  return h+'</tbody></table>';
}

/* ===== Dark Mode ===== */
$('darkToggle').onclick=()=>{
  document.body.classList.toggle('dark');
  $('darkToggle').textContent=document.body.classList.contains('dark')
    ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
};
</script>

</body>
</html>
