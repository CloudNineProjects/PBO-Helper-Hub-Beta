<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PBO Route Planner</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
:root{
  --bg-light:#666769;
  --bg-dark:#1A252C;
  --card-light:#02491D;
  --card-dark:#023804;
  --accent:#F0F0F0;
  --text-light:#F0F0F0;
}
html,body{margin:0;font-family:Inter,system-ui,Arial,sans-serif}
body{background:var(--bg-light);color:var(--text-light)}
body.dark{background:var(--bg-dark)}
.wrap{max-width:940px;margin:26px auto;padding:16px}
.card{border-radius:12px;padding:18px;background:var(--card-light);box-shadow:0 10px 30px rgba(0,0,0,.1)}
body.dark .card{background:var(--card-dark)}
label{display:block;margin-top:10px}
select,button{width:100%;padding:10px;border-radius:8px;margin-top:6px}
.controls{display:flex;gap:10px;margin-top:10px}
.controls button{width:auto}
.results{margin-top:12px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,.15)}
.preview img{max-width:360px;border-radius:8px;cursor:pointer}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center}
.modal img{max-width:95%;max-height:95%}
.mode-toggle{position:fixed;top:12px;right:12px;cursor:pointer;background:#fff;color:#000;padding:6px 10px;border-radius:8px}
body.dark .mode-toggle{background:#000;color:#fff}
</style>
</head>

<body>

<div id="modeToggle" class="mode-toggle">ðŸŒ™ Dark Mode</div>

<!-- Loading -->
<div id="loading" style="text-align:center;margin-top:80px">
  <img src="https://i.imgur.com/XZcfQzw.png" width="180"><br><br>
  <button id="loadBtn">Load Data</button>
  <div id="loadingText" style="margin-top:8px"></div>
</div>

<!-- App -->
<div id="app" class="wrap" style="display:none">

<!-- ROUTE PLANNER (UNVERÃ„NDERT) -->
<div class="card">

<label>Region</label>
<select id="regionSelect"></select>

<label>Location</label>
<select id="locationSelect" disabled></select>

<div class="controls">
  <button id="showBtn">Show</button>
  <button id="resetBtn">Reset</button>
</div>

<div id="out" class="results"></div>
<div id="imagePreview" class="preview"></div>

</div>

<!-- EV SPOT FINDER -->
<div class="card" style="margin-top:16px">

<h3>EV Spot Finder</h3>

<label>Region</label>
<select id="evRegion"></select>

<label>EV</label>
<select id="evSelect" disabled></select>

<div class="controls">
  <button id="evShow">Show</button>
  <button id="evReset">Reset</button>
</div>

<div id="evOutput" class="results"></div>

</div>
</div>

<!-- Modal -->
<div id="modal" class="modal"><img id="modalImg"></div>

<script>
/* ================= ROUTE PLANNER ================= */

const ROUTE_CSV =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vR1exPBTlYsrTJ0U4eLuFycLc6Vwwj3jtKgc6s4jZZa7UbSJLB_LJkcnIigkaJIYtBNHsicju6cv3FJ/pub?output=csv";

let rows=[],fields=[],keyRegion,keyLocation,keyTeleport,keyDirection,keyMap;

function findKey(c){return fields.find(f=>f.toLowerCase().includes(c))}

function loadRoute(){
Papa.parse(ROUTE_CSV,{
download:true,header:true,
complete:r=>{
rows=r.data;fields=r.meta.fields;
keyRegion=findKey("region");
keyLocation=findKey("location");
keyTeleport=findKey("teleport");
keyDirection=findKey("direction");
keyMap=findKey("map");
populateRegions();
}
});
}

function populateRegions(){
const sel=regionSelect;
sel.innerHTML='<option value="">Choose</option>';
[...new Set(rows.map(r=>r[keyRegion]))].forEach(v=>sel.add(new Option(v,v)));
}

regionSelect.onchange=()=>{
locationSelect.innerHTML='<option value="">Choose</option>';
locationSelect.disabled=true;
rows.filter(r=>r[keyRegion]===regionSelect.value)
.forEach(r=>locationSelect.add(new Option(r[keyLocation],r[keyLocation])));
locationSelect.disabled=false;
}

showBtn.onclick=()=>{
const res=rows.filter(r=>r[keyRegion]===regionSelect.value && r[keyLocation]===locationSelect.value);
out.innerHTML=renderTable(res);
imagePreview.innerHTML='';
res.forEach(r=>{
if(r[keyMap]){
const img=document.createElement("img");
img.src=r[keyMap];
img.onclick=()=>openModal(r[keyMap]);
imagePreview.appendChild(img);
}});
}

resetBtn.onclick=()=>location.reload();

function renderTable(r){
if(!r.length)return"";
let h=`<table><tr><th>${keyTeleport}</th><th>${keyDirection}</th></tr>`;
r.forEach(x=>h+=`<tr><td>${x[keyTeleport]}</td><td>${x[keyDirection]}</td></tr>`);
return h+"</table>";
}

/* ================= EV SPOT FINDER ================= */

const EV_CSV =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vS3s-al3s9rwdhK0FHls7J368zMl0Hdryc_y6MVwwXaiWLpgzImXs_9YsC5lXkwRdi_aPMi_gRHfsei/pub?output=csv";

let evRows=[],evFields=[];

function loadEv(){
Papa.parse(EV_CSV,{
download:true,header:true,
complete:r=>{
evRows=r.data;evFields=r.meta.fields;
populateEv();
}
});
}

function populateEv(){
evRegion.innerHTML='<option value="">Choose</option>';
[...new Set(evRows.map(r=>r[evFields[0]]))].forEach(v=>evRegion.add(new Option(v,v)));
}

evRegion.onchange=()=>{
evSelect.innerHTML='<option value="">Choose</option>';
evSelect.disabled=true;
evRows.filter(r=>r[evFields[0]]===evRegion.value)
.forEach(r=>evSelect.add(new Option(r[evFields[2]],r[evFields[2]])));
evSelect.disabled=false;
}

evShow.onclick=()=>{
const res=evRows.filter(r=>r[evFields[0]]===evRegion.value && r[evFields[2]]===evSelect.value);
evOutput.innerHTML=renderEv(res);
}

evReset.onclick=()=>{
evRegion.selectedIndex=0;
evSelect.innerHTML='';
evOutput.innerHTML='';
}

function renderEv(r){
if(!r.length)return"No results";
let h="<table><tr>";
evFields.slice(0,5).forEach(f=>h+=`<th>${f}</th>`);
h+="</tr>";
r.forEach(x=>{
h+="<tr>";
evFields.slice(0,5).forEach(f=>h+=`<td>${x[f]||""}</td>`);
h+="</tr>";
});
return h+"</table>";
}

/* ================= SHARED ================= */

function openModal(src){
modal.style.display="flex";
modalImg.src=src;
}
modal.onclick=()=>modal.style.display="none";

modeToggle.onclick=()=>{
document.body.classList.toggle("dark");
modeToggle.textContent=document.body.classList.contains("dark")?"â˜€ï¸ Light":"ðŸŒ™ Dark";
}

loadBtn.onclick=()=>{
loadingText.textContent="Loadingâ€¦";
loadRoute();
loadEv();
loading.style.display="none";
app.style.display="block";
}
</script>

</body>
</html>
